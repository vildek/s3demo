{"status":{},"contains_secrets":false,"product_version":"3.0.0.0","spec":{"description":"","resources":{"endpoint_definition_list":[],"runbook":{"task_definition_list":[{"retries":"0","description":"","child_tasks_local_reference_list":[{"kind":"app_task","name":"Cleaning old files"},{"kind":"app_task","name":"Git Clone s3app Repo"},{"kind":"app_task","name":"Build Docker Image S3App"},{"kind":"app_task","name":"Push new image to Private Docker Registry"},{"kind":"app_task","name":"Run image"},{"kind":"app_task","name":"Output container logs"}],"name":"83b0b0d6_dag","attrs":{"edges":[{"from_task_reference":{"kind":"app_task","name":"Cleaning old files"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Git Clone s3app Repo"}},{"from_task_reference":{"kind":"app_task","name":"Git Clone s3app Repo"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Build Docker Image S3App"}},{"from_task_reference":{"kind":"app_task","name":"Build Docker Image S3App"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Push new image to Private Docker Registry"}},{"from_task_reference":{"kind":"app_task","name":"Push new image to Private Docker Registry"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Run image"}},{"from_task_reference":{"kind":"app_task","name":"Run image"},"edge_type":"user_defined","type":"","to_task_reference":{"kind":"app_task","name":"Output container logs"}}],"type":""},"timeout_secs":"0","type":"DAG","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Cleaning old files","attrs":{"exit_status":[],"script":"echo \"Removing old images\"\nsudo bash -c \"sudo docker image ls | grep vildek\/@@{application}@@ |awk {'print \\$3'} |  xargs sudo docker rmi --force\" &>\/dev\/null\necho \"Done\"\necho \"Removing old files\"\ncd \/home\/demo\/\nrm -rf temp\/\nrm -rf @@{application}@@\/\necho \"Done\"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Git Clone s3app Repo","attrs":{"exit_status":[],"script":"cd \/home\/demo\/\nmkdir temp\nmkdir @@{application}@@\necho \"Cloning s3app repository\"\ngit clone https:\/\/github.com\/vildek\/@@{application}@@.git \/home\/demo\/temp\/\necho \"Copying new files to application directory\"\ncp temp\/* @@{application}@@\/\ncp -r temp\/public\/ @@{application}@@\/\necho \"Done\"\n\n\n\n\n\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Build Docker Image S3App","attrs":{"exit_status":[],"script":"cd \/home\/demo\/s3demo\nrm -f variables.js\nsudo cat << EOF > variables.js\n  const ID = '@@{AccessKey}@@';\n  const SECRET = '@@{SecretKey}@@';\n  const BUCKET_NAME = '@@{BucketName}@@';\n  const ENDPOINT = '@@{EndpointURL}@@';\n\n  module.exports = {\n    id: ID,\n    secret: SECRET,\n    bucketName: BUCKET_NAME,\n    endpoint: ENDPOINT\n  }\nEOF\n\n\ncd \/home\/demo\/@@{application}@@\nsudo bash -c 'docker build -t vildek\/@@{application}@@ .'\necho \"Done building image\"\nsudo bash -c 'docker image ls -a | grep vildek\/@@{application}@@'","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Push new image to Private Docker Registry","attrs":{"exit_status":[],"script":"sudo bash -c 'docker tag vildek\/@@{application}@@ reg.demobox.lv:5000\/@@{application}@@:@@{version}@@'\nsudo bash -c 'cat \/home\/demo\/pass | docker login --username admin --password-stdin https:\/\/reg.demobox.lv:5000'\nsudo bash -c 'docker push reg.demobox.lv:5000\/@@{application}@@:@@{version}@@'\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Run image","attrs":{"exit_status":[],"script":"sudo bash -c 'docker run -p @@{DockerPort}@@:@@{containerPort}@@ -d reg.demobox.lv:5000\/@@{application}@@:@@{version}@@'\nsudo bash -c 'docker ps'\n","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]},{"retries":"0","description":"","child_tasks_local_reference_list":[],"name":"Output container logs","attrs":{"exit_status":[],"script":"sleep 5\nsudo bash -c \"docker container ls -a | grep reg.demobox.lv:5000\/@@{application}@@:@@{version}@@ | awk '{print \\$1}'| xargs docker container logs \"","script_type":"sh","type":"","command_line_args":"","login_credential_local_reference":{"kind":"app_credential","name":"centos"}},"timeout_secs":"0","type":"EXEC","variable_list":[]}],"description":"","name":"214e0171_runbook","main_task_local_reference":{"kind":"app_task","name":"83b0b0d6_dag"},"variable_list":[{"regex":{"should_validate":false,"value":"^.*$"},"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"version","value":"1.0.1","label":"Docker Image Tag Version","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"regex":{"should_validate":false,"value":"^[\\d]*$"},"val_type":"INT","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"DockerPort","value":"30000","label":"Docker Host Container Port","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"application","value":"s3demo","label":"Github application name","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":false,"description":"","data_type":"BASE","type":"LOCAL","name":"containerPort","value":"3000","label":"Container Port","attrs":{"type":""},"editables":{"value":true},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"AccessKey","value":"","label":"S3 Bucket Access Key","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"SECRET","name":"SecretKey","value":"","label":"S3 Bucket Secret Key","attrs":{"is_secret_modified":false,"secret_reference":{},"type":"SECRET"},"editables":{"value":false},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"BucketName","value":"s3appbucket","label":"S3 Bucket Name","attrs":{"type":""},"editables":{"value":false},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}},{"val_type":"STRING","is_mandatory":true,"description":"","data_type":"BASE","type":"LOCAL","name":"EndpointURL","value":"http:\/\/s3.demobox.lv","label":"S3 storage API Address","attrs":{"type":""},"editables":{"value":false},"is_hidden":false,"options":{"type":"PREDEFINED","choices":[]}}]},"client_attrs":{},"credential_definition_list":[{"username":"centos","description":"","type":"KEY","secret":{"attrs":{"is_secret_modified":false,"secret_reference":{}}},"name":"centos"}],"default_target_reference":{"kind":"app_endpoint","name":"DockerHost"}},"name":"S3 Demo App Pipeline"},"api_version":"3.0","metadata":{"last_update_time":"1597401926662526","kind":"runbook","spec_version":4,"creation_time":"1597395465996112","name":"S3 Demo App Pipeline"}}